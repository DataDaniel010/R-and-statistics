---
title: "Experiment_planning"
author: "Glazkov A.A."
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(TrialSize)
library(epiR)

set.seed(5553535)

```

# Моделируем ошибку первого рода

## Функция, которая моделирует 1 эксперимент
n - количество элементов в выборках, параметры выборок - m1, sd1, m2, sd2
tibble - делаем таблицу с полученными данными

```{r}

experiment <- function(n, m1, sd1, m2, sd2){
    
    sample1 <- rnorm(n, m1, sd1) # Геренируем выборку 1
    sample2 <- rnorm(n, m2, sd2) # Генерируем выборку 2
    
    test_res <- t.test(sample1, sample2) # Проводим t-test
    
    tibble(p = test_res$p.value,                               # p-value
           H0_rejected = ifelse(p < 0.05, 1, 0),               # "1", если отвергли H0 и "0", если нет
           diff = test_res$estimate[1] - test_res$estimate[2]) # различия m1 - m2
    
}

```

Проверим как функция работает:

```{r}

experiment(50, 10, 1, 11, 1) # Проводим единичный эксперимент

```

## Проведём 1000 экспериментов с верной H0
lapply - цикл, задаем количество, задаем аргумент i 

```{r}

# Задаём условия

m1 <- m2 <- 20
sd1 <- sd2 <- 10

# Задаём n

n <- 50

# Повторяем эксперимент 1000 раз и сохраняем результаты каждого эксперимента 
# в таблицу series_1

series_1 <- lapply(1:1000, function(i) experiment(n, m1, sd1, m2, sd2)) %>% bind_rows() 

series_1 %>% head()

```

Cколько раз H0 была отвергнута в этой тысяче экспериментов?

```{r}

mean(series_1$H0_rejected)

```

С какой частотой мы с вами совершили ошибку первого рода?


## 10 раз проведём по 1000 экспериментов с разной численностью наблюдений 

Подставьте свои значения для m1 и m2

```{r}

# Задаём условия

m1 <- m2 <- 99
sd1 <- sd2 <- 13

# Выбираем количество итераций

iterations <- 1000

# Пишем "цикл" в "цикле"
# Для 20, 40, 60 ... 200 наблюдений проводим серии по 1000 экспериментов

lapply(seq(20, 200, 20), function(n){
    lapply(1:iterations, function(i) experiment(n, m1, sd1, m2, sd2)) %>% 
        bind_rows() -> series_result
    
    tibble(
        n,                                                                      # Количество наблюдений
        H0_rejection_rate = mean(series_result$H0_rejected),                    # Частота отклонения H0
        Mean_diff = mean(series_result[series_result$H0_rejected == 1,]$diff),  # Средняя величина различий при отклонении H0
        Var_diff = var(series_result[series_result$H0_rejected == 1,]$diff)     # Дисперсия величины различий при отклонении H0
    )
}) %>% bind_rows() -> type_I_results

type_I_results
```

Построим наглядные графики:

```{r, fig.height=2.5, fig.width=5, dpi=300}

# Частота совершения ошибки первого рода составила...

type_I_results %>% 
    ggplot(aes(x = n, y = H0_rejection_rate)) + 
    geom_bar(stat = "identity",
             fill = "red",
             alpha = 0.5,
             color = "black") + 
    geom_hline(yintercept = 0.05,
               linetype = "dashed",
               linewidth = 0.75) +
    scale_y_continuous(limits = c(0, 0.1)) +
    scale_x_continuous(breaks = seq(20, 200, 20)) +
    geom_text(x = 180, y = 0.1,
              label = str_c("m1 = ", m1, ", sd1 = ", sd1,
                            "\nm2 = ", m2, ", sd2 = ", sd2),
              vjust = 1,
              size = 3) + 
    theme_bw()    

```
Как видим частота ошибки первого рода вообще не зависит от объема выборки, но малый объем выборки приводит к негативным эффектам.

```{r, fig.height=2.5, fig.width=5, dpi=300}

# Дисперсия для разности m1 - m2 (при отклонении H0):

type_I_results %>% 
    ggplot(aes(x = n, y = Var_diff)) + 
    geom_bar(stat = "identity",
             fill = "grey",
             alpha = 0.5,
             color = "black") + 
    scale_x_continuous(breaks = seq(20, 200, 20)) +
    theme_bw()    

```
На маленькой выборке разница будет больше, более критично (если ориентироваться только на средние значения), чем на большой. 

# Моделируем ошибку второго рода

## Эксперимент № 1

```{r}

# Задаём условия

m1 <- 10
m2 <- 11
sd1 <- sd2 <- 2

# Количество итераций

iterations <- 1000

# Пишем "цикл" в "цикле"
# Для 20, 40, 60 ... 200 наблюдений проводим серии по 1000 экспериментов

lapply(seq(20, 200, 20), function(n){
    lapply(1:iterations, function(i) experiment(n, m1, sd1, m2, sd2)) %>% 
        bind_rows() -> series_result
    
    tibble(
        n,                                                                      # Количество наблюдений
        H0_rejection_rate = sum(series_result$H0_rejected) / iterations,        # Частота отклонения H0
        Mean_diff = mean(series_result[series_result$H0_rejected == 1,]$diff),  # Средняя величина различий при отклонении H0
        SD_diff = sd(series_result[series_result$H0_rejected == 1,]$diff)       # Станд. отклон. велилчины различий при отклонении
    )
}) %>% bind_rows() -> type_II_results_1

type_II_results_1

```

```{r, fig.height=2.5, fig.width=5, dpi=300}

# Частота совершения ошибки второго рода составила

type_II_results_1 %>% 
    ggplot(aes(x = n, y = H0_rejection_rate)) + 
    geom_bar(stat = "identity",
             fill = "lightblue",
             alpha = 0.5,
             color = "black") + 
    geom_hline(yintercept = 0.8,
               linetype = "dashed",
               linewidth = 0.75) +
    scale_y_continuous(limits = c(0, 1)) +
    scale_x_continuous(breaks = seq(20, 200, 20)) +
    geom_text(x = 10, y = 1,
              label = str_c("m1 = ", m1, ", sd1 = ", sd1,
                            "\nm2 = ", m2, ", sd2 = ", sd2),
              vjust = 1,
              hjust = 0,
              size = 3) + 
    theme_bw() 

```
Часть над столбиками до единицы - ошибка второго рода. 
Столбики - мощность исследования (1 - ошибка 2го рода) Мощность более 80% наблюдаем на 60 и более наблюдениях Так можно прикидывать мощность исследований.

## Эксперимент № 2

```{r}

m1 <- 10
m2 <- 11
sd1 <- sd2 <- 4

iterations <- 1000

lapply(seq(20, 200, 20), function(n){
    lapply(1:iterations, function(i) experiment(n, m1, sd1, m2, sd2)) %>% 
        bind_rows() -> series_result
    
    tibble(
        n,                                                                      # Количество наблюдений
        H0_rejection_rate = sum(series_result$H0_rejected) / iterations,        # Частота отклонения H0
        Mean_diff = mean(series_result[series_result$H0_rejected == 1,]$diff),  # Средняя величина различий при отклонении H0
        SD_diff = sd(series_result[series_result$H0_rejected == 1,]$diff)       # Станд. отклон. велилчины различий при отклонении
    )
}) %>% bind_rows() -> type_II_results_2

type_II_results_2

```

```{r, fig.height=2.5, fig.width=5, dpi=300}

# Частота совершения ошибки второго рода составила

type_II_results_2 %>% 
    ggplot(aes(x = n, y = H0_rejection_rate)) + 
    geom_bar(stat = "identity",
             fill = "lightblue",
             alpha = 0.5,
             color = "black") + 
    geom_hline(yintercept = 0.8,
               linetype = "dashed",
               linewidth = 0.75) +
    scale_y_continuous(limits = c(0, 1)) +
    scale_x_continuous(breaks = seq(20, 200, 20)) +
    geom_text(x = 10, y = 1,
              label = str_c("m1 = ", m1, ", sd1 = ", sd1,
                            "\nm2 = ", m2, ", sd2 = ", sd2),
              vjust = 1,
              hjust = 0,
              size = 3) + 
    theme_bw()    

```
Увеличив стандартное отклонение мощности в 80% не достигаем даже на 200 наблюдениях

# Расчёт размера выборки

## Количественная конечная точка

Исследование превосходства 

Предыстория: в пилотном исследовании было показано, что некий препарат позволяет классно снижать массу тела у пациентов. Масса тела за 3 месяца диеты в сочетании с препаратом снизилась на 12±5 %. 

Задача: провести клиническое исследование III фазы и продемонстрировать эффективность препарата в сравнении с плацебо

Конечная точка: Снижение массы тела за 3 месяца в % от исходного уровня

Из данных литературы известно, что на диете масса тела снижается на 5±5 %.

Клинически значимая разница - разница в 5%

Гипотеза превосходства является односторонней, поэтому в исследовании будет использован уровень альфа 0.025 (так как гипотеза превосходства является односторонней и тесты оценивют только нижнюю границу интервала, верхняя нам не важна, таким образом будет возможность построить двусторонний доверительный интервал и тестировать одностороннюю стат гипотезу), уровень мощности - 80%

При таком уровне альфа односторнний 97,5% интервал и 95% интервал будут равнозначны и поэтому строим двусторонний интервал, но тестируем одностороннюю стат гипотезу. Мы хотим увидеть не только ситуацию, когда препарат лучше, но и ситуацию, когда препарат хуже, хотим, чтобы исследование было достаточно мощным. Чтобы увидеть, что препарат хуже нужна верхняя граница ДИ, при 95% интервале отсекается по 2,5 процента с каждой стороны, поэтому и проверяем 0,025. В различных тестах гипотезы по умолчанию двусторонние. 

Важно строить доверительные интервалы двусторонние


```{r}

?TwoSampleMean.NIS

# Проведём расчёт, наше исследование superiority

TwoSampleMean.NIS(
    alpha = 0.025,
    beta = 0.2,       #это 1 - мощность (вероятность ошибки второго рода). Мощность 1 - beta
    sigma = 5,        #pooled standart deviation of two groups -взвешенное стандартное отклонение, среднее арифметическое двух СД дву групп (в нашем случае в обоих группах sd = 5%)
    k = 1,           # соотношение пациентов в группах, если будет отличаться от единицы общее количество наблюдений в обе группы будет расти
    delta = 7,       # это разница между группами!
    margin = 5       # это граница не меньшей эффективности!
)


```
При k = 1 в нашем случае требуется 99 человек, но в клин исследованиях также учитывается процент выбывания из исследования, процент прохождения скрининга 

Обрадуемся высокой информативности полученной выдачи и попробуем перепроверить 
расчёт в другом пакете.


```{r}
?epi.ssupc

epi.sssupc(
    treat = 12,
    control = 5,
    sigma = 5,
    delta = 5,      # это граница не меньшей эффективности!
    n = NA,         # количество пациентов, он сам на посчитает, но можем сами указать количество и тогда функция рассчитает нам допустим мощность (если ее приравняем к NA)
    r = 1,
    alpha = 0.025,
    power = 0.8
)

```

В каждую группу необходимо включить не менее 99 пациентов.

## Качественная конечная точка

Предыстория: в пилотном исследовании было показано, что некий препарат позволяет
классно снижать массу тела у пациентов. Масса тела за 3 месяца диеты в сочетании 
с препаратом снизилась на 5% и более у 90% пациентов. 


Задача: провести клиническое исследование III фазы и продемонстрировать 
эффективность препарата в сравнении с плацебо


Конечная точка: Доля пациентов со снижением массы тела на 5% и более


Из данных литературы известно, что на диете масса тела снижается на 5% и более 
у 70% пациентов.


Клинически значимая разница - разница в 5%


Гипотеза превосходства является односторонней, поэтому в исследовании будет
использован уровень альфа 0.025, уровень мощности - 80%

Попробуйте посчитать размер выборки: 

Сколько нужно пациентов в каждую группу?
указываем частоту в группе 1, в группе 2, границу разности 

```{r}

TwoSampleProportion.NIS(
    alpha = ,
    beta = ,
    p1 = ,
    p2 = ,
    k = ,
    delta = ,
    margin = 
)

```


```{r}

epi.sssupb(
    treat = ,
    control = ,
    delta = ,
    n = ,
    r = ,
    power = ,
    alpha = 
)

```




